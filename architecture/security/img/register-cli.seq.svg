<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1244px" preserveAspectRatio="none" style="width:690px;height:1244px;background:#FFFFFF;" version="1.1" viewBox="0 0 690 1244" width="690px" zoomAndPan="magnify"><defs><filter height="300%" id="f17rjeyxylnlne" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#f17rjeyxylnlne)" height="1157.1113" style="stroke:#A80036;stroke-width:1.0;" width="10" x="220.5" y="71.7988"/><rect fill="#FFFFFF" filter="url(#f17rjeyxylnlne)" height="198.1738" style="stroke:#A80036;stroke-width:1.0;" width="10" x="449.5" y="259.9727"/><rect fill="#FFFFFF" filter="url(#f17rjeyxylnlne)" height="325.7266" style="stroke:#A80036;stroke-width:1.0;" width="10" x="449.5" y="565.0781"/><rect fill="#FFFFFF" filter="url(#f17rjeyxylnlne)" height="207.0186" style="stroke:#A80036;stroke-width:1.0;" width="10" x="449.5" y="944.2705"/><rect fill="#FFFFFF" filter="url(#f17rjeyxylnlne)" height="812.0059" style="stroke:#000000;stroke-width:2.0;" width="666.5" x="10" y="86.7988"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="44" x2="44" y1="40.4883" y2="1237.9102"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="225" x2="225" y1="40.4883" y2="1237.9102"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="454" x2="454" y1="40.4883" y2="1237.9102"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="642.5" x2="642.5" y1="40.4883" y2="1237.9102"/><rect fill="#FEFECE" filter="url(#f17rjeyxylnlne)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="45" x="20" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="27" y="25.5352">User</text><rect fill="#FEFECE" filter="url(#f17rjeyxylnlne)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="35" x="206" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="21" x="213" y="25.5352">CLI</text><rect fill="#FEFECE" filter="url(#f17rjeyxylnlne)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="71" x="417" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="57" x="424" y="25.5352">Gateway</text><rect fill="#FEFECE" filter="url(#f17rjeyxylnlne)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="44" x="618.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30" x="625.5" y="25.5352">Ably</text><rect fill="#FFFFFF" filter="url(#f17rjeyxylnlne)" height="1157.1113" style="stroke:#A80036;stroke-width:1.0;" width="10" x="220.5" y="71.7988"/><rect fill="#FFFFFF" filter="url(#f17rjeyxylnlne)" height="198.1738" style="stroke:#A80036;stroke-width:1.0;" width="10" x="449.5" y="259.9727"/><rect fill="#FFFFFF" filter="url(#f17rjeyxylnlne)" height="325.7266" style="stroke:#A80036;stroke-width:1.0;" width="10" x="449.5" y="565.0781"/><rect fill="#FFFFFF" filter="url(#f17rjeyxylnlne)" height="207.0186" style="stroke:#A80036;stroke-width:1.0;" width="10" x="449.5" y="944.2705"/><polygon fill="#A80036" points="208.5,67.7988,218.5,71.7988,208.5,75.7988,212.5,71.7988" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="44.5" x2="214.5" y1="71.7988" y2="71.7988"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="51.5" y="67.0566">open account/timesheet</text><path d="M10,86.7988 L72,86.7988 L72,93.7988 L62,103.7988 L10,103.7988 L10,86.7988 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="812.0059" style="stroke:#000000;stroke-width:2.0;" width="666.5" x="10" y="86.7988"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="17" x="25" y="100.3672">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="172" x="87" y="99.4336">[No Ably Key (AbK) or expired]</text><path d="M73,109.1094 L73,167.1094 L374,167.1094 L374,119.1094 L364,109.1094 L73,109.1094 " fill="#FBFB77" filter="url(#f17rjeyxylnlne)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M364,109.1094 L364,119.1094 L374,119.1094 L364,109.1094 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="79" y="126.6777">configured user is account</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="6" x="247" y="130.3105">u</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="64" x="257" y="126.6777">(required).</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="280" x="79" y="144.9883">Not always the same as requested timesheet</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="254" x="79" y="160.2988">account (which may be an organisation).</text><polygon fill="#A80036" points="55.5,194.3516,45.5,198.3516,55.5,202.3516,51.5,198.3516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="49.5" x2="219.5" y1="198.3516" y2="198.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="103" x="61.5" y="193.6094">"pls enter email"</text><polygon fill="#A80036" points="208.5,223.6621,218.5,227.6621,208.5,231.6621,212.5,227.6621" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="44.5" x2="214.5" y1="227.6621" y2="227.6621"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="34" x="51.5" y="222.9199">email</text><polygon fill="#A80036" points="437.5,255.9727,447.5,259.9727,437.5,263.9727,441.5,259.9727" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="230.5" x2="443.5" y1="259.9727" y2="259.9727"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="75" x="237.5" y="252.2305">jwe(account</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="6" x="312.5" y="255.8633">u</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="46" x="318.5" y="252.2305">, email)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="459.5" x2="501.5" y1="310.5938" y2="310.5938"/><line style="stroke:#A80036;stroke-width:1.0;" x1="501.5" x2="501.5" y1="310.5938" y2="323.5938"/><line style="stroke:#A80036;stroke-width:1.0;" x1="460.5" x2="501.5" y1="323.5938" y2="323.5938"/><polygon fill="#A80036" points="470.5,319.5938,460.5,323.5938,470.5,327.5938,466.5,323.5938" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="63" x="466.5" y="284.541">If account</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="6" x="529.5" y="288.1738">u</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="83" x="539.5" y="284.541">exists, check</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="50" x="466.5" y="302.8516">account</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="6" x="516.5" y="306.4844">u</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="526.5" y="302.8516">and email match</text><polygon fill="#A80036" points="241.5,373.7148,231.5,377.7148,241.5,381.7148,237.5,377.7148" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="235.5" x2="448.5" y1="377.7148" y2="377.7148"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="19" x="247.5" y="369.9727">jwt</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="6" x="266.5" y="373.6055">a</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="276.5" y="369.9727">encrypted with code</text><path d="M19,336.5938 L19,397.5938 L211,397.5938 L211,346.5938 L201,336.5938 L19,336.5938 " fill="#FBFB77" filter="url(#f17rjeyxylnlne)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M201,336.5938 L201,346.5938 L211,346.5938 L201,336.5938 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="19" x="25" y="354.1621">jwt</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="6" x="44" y="357.7949">a</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="93" x="54" y="354.1621">(activation jwt)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="85" x="25" y="372.4727">has ⦉ account</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="6" x="110" y="376.1055">u</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="51" x="116" y="372.4727">, email ⦊</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="171" x="25" y="390.7832">signed with Gateway secret</text><polygon fill="#A80036" points="55.5,424.8359,45.5,428.8359,55.5,432.8359,51.5,428.8359" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="49.5" x2="219.5" y1="428.8359" y2="428.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="61.5" y="424.0938">"pls enter emailed code"</text><polygon fill="#A80036" points="55.5,454.1465,45.5,458.1465,55.5,462.1465,51.5,458.1465" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="49.5" x2="453.5" y1="458.1465" y2="458.1465"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="153" x="61.5" y="453.4043">activation code by email</text><polygon fill="#A80036" points="208.5,483.457,218.5,487.457,208.5,491.457,212.5,487.457" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="44.5" x2="214.5" y1="487.457" y2="487.457"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="30" x="51.5" y="482.7148">code</text><line style="stroke:#A80036;stroke-width:1.0;" x1="230.5" x2="272.5" y1="519.7676" y2="519.7676"/><line style="stroke:#A80036;stroke-width:1.0;" x1="272.5" x2="272.5" y1="519.7676" y2="532.7676"/><line style="stroke:#A80036;stroke-width:1.0;" x1="231.5" x2="272.5" y1="532.7676" y2="532.7676"/><polygon fill="#A80036" points="241.5,528.7676,231.5,532.7676,241.5,536.7676,237.5,532.7676" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="237.5" y="512.0254">decrypt jwt</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="6" x="307.5" y="515.6582">a</text><polygon fill="#A80036" points="437.5,561.0781,447.5,565.0781,437.5,569.0781,441.5,565.0781" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="230.5" x2="443.5" y1="565.0781" y2="565.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="45" x="237.5" y="557.3359">key(jwt</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="6" x="282.5" y="560.9688">a</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="288.5" y="557.3359">)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="459.5" x2="501.5" y1="609.6992" y2="609.6992"/><line style="stroke:#A80036;stroke-width:1.0;" x1="501.5" x2="501.5" y1="609.6992" y2="622.6992"/><line style="stroke:#A80036;stroke-width:1.0;" x1="460.5" x2="501.5" y1="622.6992" y2="622.6992"/><polygon fill="#A80036" points="470.5,618.6992,460.5,622.6992,470.5,626.6992,466.5,622.6992" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94" x="466.5" y="589.6465">create Account</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65" x="466.5" y="604.957">if required</text><polygon fill="#A80036" points="470.5,663.3203,460.5,667.3203,470.5,671.3203,466.5,667.3203" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="630.5,663.3203,640.5,667.3203,630.5,671.3203,634.5,667.3203" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="464.5" x2="636.5" y1="667.3203" y2="667.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="476.5" y="647.2676">create/update Ably key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="476.5" y="662.5781">(AbK) &amp; capabilities</text><line style="stroke:#A80036;stroke-width:1.0;" x1="459.5" x2="501.5" y1="727.252" y2="727.252"/><line style="stroke:#A80036;stroke-width:1.0;" x1="501.5" x2="501.5" y1="727.252" y2="740.252"/><line style="stroke:#A80036;stroke-width:1.0;" x1="460.5" x2="501.5" y1="740.252" y2="740.252"/><polygon fill="#A80036" points="470.5,736.252,460.5,740.252,470.5,744.252,466.5,740.252" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="466.5" y="691.8887">generate RSA key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="97" x="466.5" y="707.1992">pair for signing</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="56" x="466.5" y="722.5098">⦉ SK, PK ⦊</text><line style="stroke:#A80036;stroke-width:1.0;" x1="459.5" x2="501.5" y1="787.873" y2="787.873"/><line style="stroke:#A80036;stroke-width:1.0;" x1="501.5" x2="501.5" y1="787.873" y2="800.873"/><line style="stroke:#A80036;stroke-width:1.0;" x1="460.5" x2="501.5" y1="800.873" y2="800.873"/><polygon fill="#A80036" points="470.5,796.873,460.5,800.873,470.5,804.873,466.5,800.873" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="126" x="466.5" y="764.8203">encrypt SK with AbK</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="31" x="466.5" y="780.1309">{ SK }</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="20" x="497.5" y="783.7637">AbK</text><line style="stroke:#A80036;stroke-width:1.0;" x1="459.5" x2="501.5" y1="848.4941" y2="848.4941"/><line style="stroke:#A80036;stroke-width:1.0;" x1="501.5" x2="501.5" y1="848.4941" y2="861.4941"/><line style="stroke:#A80036;stroke-width:1.0;" x1="460.5" x2="501.5" y1="861.4941" y2="861.4941"/><polygon fill="#A80036" points="470.5,857.4941,460.5,861.4941,470.5,865.4941,466.5,861.4941" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="97" x="466.5" y="825.4414">⦉ AbK.id ↦ { SK }</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="20" x="563.5" y="829.0742">AbK</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="32" x="583.5" y="825.4414">, PK ⦊</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="112" x="466.5" y="843.752">stored in Account</text><polygon fill="#A80036" points="241.5,886.8047,231.5,890.8047,241.5,894.8047,237.5,890.8047" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="235.5" x2="453.5" y1="890.8047" y2="890.8047"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="48" x="247.5" y="886.0625">AbK, SK</text><polygon fill="#A80036" points="437.5,940.2705,447.5,944.2705,437.5,948.2705,441.5,944.2705" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="230.5" x2="443.5" y1="944.2705" y2="944.2705"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="190" x="237.5" y="936.5283">config(account/timesheet, jwt</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="6" x="427.5" y="940.1611">u</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="433.5" y="936.5283">)</text><path d="M49,910.8047 L49,956.8047 L211,956.8047 L211,920.8047 L201,910.8047 L49,910.8047 " fill="#FBFB77" filter="url(#f17rjeyxylnlne)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M201,910.8047 L201,920.8047 L211,920.8047 L201,910.8047 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="19" x="55" y="928.373">jwt</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="6" x="74" y="932.0059">u</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="84" y="928.373">(user jwt) has</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="55" y="946.6836">{ account</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="6" x="113" y="950.3164">u</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="57" x="119" y="946.6836">, AbK.id }</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="20" x="176" y="950.3164">AbK</text><line style="stroke:#A80036;stroke-width:1.0;" x1="459.5" x2="501.5" y1="1006.0469" y2="1006.0469"/><line style="stroke:#A80036;stroke-width:1.0;" x1="501.5" x2="501.5" y1="1006.0469" y2="1019.0469"/><line style="stroke:#A80036;stroke-width:1.0;" x1="460.5" x2="501.5" y1="1019.0469" y2="1019.0469"/><polygon fill="#A80036" points="470.5,1015.0469,460.5,1019.0469,470.5,1023.0469,466.5,1019.0469" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91" x="466.5" y="982.9941">check account</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="6" x="557.5" y="986.627">u</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="466.5" y="1001.3047">corresponds to AbK.id</text><line style="stroke:#A80036;stroke-width:1.0;" x1="459.5" x2="501.5" y1="1066.668" y2="1066.668"/><line style="stroke:#A80036;stroke-width:1.0;" x1="501.5" x2="501.5" y1="1066.668" y2="1079.668"/><line style="stroke:#A80036;stroke-width:1.0;" x1="460.5" x2="501.5" y1="1079.668" y2="1079.668"/><polygon fill="#A80036" points="470.5,1075.668,460.5,1079.668,470.5,1083.668,466.5,1079.668" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91" x="466.5" y="1043.6152">check account</text><text fill="#000000" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="6" x="557.5" y="1047.248">u</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="22" x="567.5" y="1043.6152">has</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="125" x="466.5" y="1061.9258">access to timesheet</text><line style="stroke:#A80036;stroke-width:1.0;" x1="459.5" x2="501.5" y1="1108.9785" y2="1108.9785"/><line style="stroke:#A80036;stroke-width:1.0;" x1="501.5" x2="501.5" y1="1108.9785" y2="1121.9785"/><line style="stroke:#A80036;stroke-width:1.0;" x1="460.5" x2="501.5" y1="1121.9785" y2="1121.9785"/><polygon fill="#A80036" points="470.5,1117.9785,460.5,1121.9785,470.5,1125.9785,466.5,1121.9785" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="466.5" y="1104.2363">update key capability</text><polygon fill="#A80036" points="241.5,1147.2891,231.5,1151.2891,241.5,1155.2891,237.5,1151.2891" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="235.5" x2="453.5" y1="1151.2891" y2="1151.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="40" x="247.5" y="1146.5469">config</text><polygon fill="#A80036" points="630.5,1176.5996,640.5,1180.5996,630.5,1184.5996,634.5,1180.5996" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="230.5" x2="636.5" y1="1180.5996" y2="1180.5996"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="251" x="237.5" y="1175.8574">connect to timesheet channels via m-ld</text><path d="M25,1193.5996 L25,1218.5996 L245,1218.5996 L245,1203.5996 L235,1193.5996 L25,1193.5996 " fill="#FBFB77" filter="url(#f17rjeyxylnlne)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M235,1193.5996 L235,1203.5996 L245,1203.5996 L235,1193.5996 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="132" x="62.5" y="1211.168">Proceed with session</text><!--MD5=[2eb475f78547f61af2e618d40cd38290]
@startuml
'https://plantuml.com/sequence-diagram
hide footbox

User -> CLI ++: open account/timesheet
alt No Ably Key (AbK) or expired
  note over CLI
    configured user is account<sub>u</sub> (required).
    Not always the same as requested timesheet
    account (which may be an organisation).
  end note
  CLI -> User: "pls enter email"
  User - -> CLI: email
  CLI -> Gateway ++: jwe(account<sub>u</sub>, email)
  Gateway -> Gateway: If account<sub>u</sub> exists, check\naccount<sub>u</sub> and email match
  Gateway - -> CLI: jwt<sub>a</sub> encrypted with code
  note left
    jwt<sub>a</sub> (activation jwt)
    has ⦉ account<sub>u</sub>, email ⦊
    signed with Gateway secret
  end note
  CLI -> User: "pls enter emailed code"
  Gateway - -> User - -: activation code by email

  User - -> CLI: code
  ' TODO: brute force attack (look for a parseable JWT)
  CLI -> CLI: decrypt jwt<sub>a</sub>
  ' TODO: replay attack within JWT validity period
  CLI -> Gateway ++: key(jwt<sub>a</sub>)
  
  Gateway -> Gateway: create Account\nif required
  Gateway <-> Ably: create/update Ably key\n(AbK) & capabilities
  Gateway -> Gateway: generate RSA key\npair for signing\n⦉ SK, PK ⦊
  Gateway -> Gateway: encrypt SK with AbK\n{ SK }<sub>AbK</sub>
  Gateway -> Gateway: ⦉ AbK.id ↦ { SK }<sub>AbK</sub>, PK ⦊\nstored in Account
  return AbK, SK
end

CLI -> Gateway ++: config(account/timesheet, jwt<sub>u</sub>)
note left
  jwt<sub>u</sub> (user jwt) has
  { account<sub>u</sub>, AbK.id }<sub>AbK</sub>
end note
Gateway -> Gateway: check account<sub>u</sub>\ncorresponds to AbK.id
Gateway -> Gateway: check account<sub>u</sub> has\naccess to timesheet
Gateway -> Gateway: update key capability
return config

CLI -> Ably: connect to timesheet channels via m-ld
note over User, CLI: Proceed with session

@enduml

@startuml
hide footbox

User -> CLI ++: open account/timesheet
alt No Ably Key (AbK) or expired
  note over CLI
    configured user is account<sub>u</sub> (required).
    Not always the same as requested timesheet
    account (which may be an organisation).
  end note
  CLI -> User: "pls enter email"
  User - -> CLI: email
  CLI -> Gateway ++: jwe(account<sub>u</sub>, email)
  Gateway -> Gateway: If account<sub>u</sub> exists, check\naccount<sub>u</sub> and email match
  Gateway - -> CLI: jwt<sub>a</sub> encrypted with code
  note left
    jwt<sub>a</sub> (activation jwt)
    has ⦉ account<sub>u</sub>, email ⦊
    signed with Gateway secret
  end note
  CLI -> User: "pls enter emailed code"
  Gateway - -> User - -: activation code by email

  User - -> CLI: code
  CLI -> CLI: decrypt jwt<sub>a</sub>
  CLI -> Gateway ++: key(jwt<sub>a</sub>)
  
  Gateway -> Gateway: create Account\nif required
  Gateway <-> Ably: create/update Ably key\n(AbK) & capabilities
  Gateway -> Gateway: generate RSA key\npair for signing\n⦉ SK, PK ⦊
  Gateway -> Gateway: encrypt SK with AbK\n{ SK }<sub>AbK</sub>
  Gateway -> Gateway: ⦉ AbK.id ↦ { SK }<sub>AbK</sub>, PK ⦊\nstored in Account
  return AbK, SK
end

CLI -> Gateway ++: config(account/timesheet, jwt<sub>u</sub>)
note left
  jwt<sub>u</sub> (user jwt) has
  { account<sub>u</sub>, AbK.id }<sub>AbK</sub>
end note
Gateway -> Gateway: check account<sub>u</sub>\ncorresponds to AbK.id
Gateway -> Gateway: check account<sub>u</sub> has\naccess to timesheet
Gateway -> Gateway: update key capability
return config

CLI -> Ably: connect to timesheet channels via m-ld
note over User, CLI: Proceed with session

@enduml

PlantUML version 1.2021.10(Mon Aug 30 14:43:48 BST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: GB
--></g></svg>